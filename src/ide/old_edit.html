<!DOCTYPE html>
<!-- Copyright (C) 2020 - Oliver Lenehan - GNU GPLv3.0 -->
<html>
<head>
  <title>Zed-Edit</title>
  <link href="./zed-edit.css" rel="stylesheet">
  <style>
    body {
      position: relative;
      margin: 0 auto;
      width: 800px;
    }
    nav {
      display: grid;
      position: sticky;
      top: 0;
      background-color: var(--theme-nav-bg);
      z-index: 1;
      grid-template-columns: repeat(3, 10%) 1fr;
      border-bottom: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-right: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-left: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
    }
    .menuItem {
      height: 40px;
      overflow: hidden;
      cursor: default;
      border-right: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
    }
    .menuTitle {
      display: block;
      margin: 0;
      padding: 4px;
      height: 42px;
      text-align: center;
      font-size: 25px;
      font-weight: bold;
    }
    .menuItem:hover {overflow: visible;}
    .menuItem:hover > .menuTitle {
      background-color: var(--theme-nav-hover);
    }
    .menuList {
      position: relative;
      left: -2px;
      box-sizing: content-box;
      width: 170%;
      border-bottom: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-right: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-left: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
    }
    .menuList > button {
      box-sizing: border-box;
      width: 100%;
      font-size: 20px;
      border: none;
      outline: none;
      text-align: left;
      font-family:Cascadia;
      background-color: var(--theme-nav-menu-colour);
    }
    .menuList > button::before {content: "- ";}
    .menuList > button:hover {background-color: var(--theme-nav-menu-hover);}
    nav > h1 {
      margin: 0;
      padding: 4px;
      width: 100%;
      text-align: right;
    }
    main {
      position: relative;
      z-index: 0;
      overflow-x: scroll;
      border-bottom: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-right: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
      border-left: var(--theme-nav-border-width) solid var(--theme-nav-border-colour);
    }
    #codeInput {
      display: block;
      position: relative;
      padding: 10px;
      padding-left: 50px;
      width: 100%;
      height: 40px;
      font-family: Cascadia;
      font-size: 20px;
      resize: none;
      outline: none;
      border: none;
      color: transparent;
      caret-color: var(--theme-editor-caret);
      background-color: var(--theme-editor-bg);
      white-space: pre;
      line-height: 1.2;
      overflow: hidden;
    }
    #codeInput::selection {
      color: transparent;
      background-color: var(--theme-editor-selection);
    }
    #codePreview {
      display: block;
      position: absolute;
      top: 0;
      pointer-events: none;
      margin: 0;
      padding: 10px;
      padding-left: 10px;
      color: var(--theme-editor-fg);
      border-left: 40px solid var(--theme-editor-linecount-bg);
      width: 100%;
      height: 100%;
      line-height: 1.2;
      font-family: Cascadia;
      font-size: 20px;
      counter-reset: lineNo;
    }
    #codePreview > span {
      display: block;
      counter-increment: lineNo;
    }
    #codePreview > span::before {
      position: absolute;
      width: 40px;
      left: -45px;
      text-align: right;
      content: counter(lineNo);
      color: var(--theme-editor-linecount-fg);
    }
    .theme-editor-keyword {
      font-weight: var(--theme-editor-keyword-weight);
      font-style: var(--theme-editor-keyword-style);
      color: var(--theme-editor-keyword-colour);
    }
    .theme-editor-string {
      font-weight: var(--theme-editor-string-weight);
      font-style: var(--theme-editor-string-style);
      color: var(--theme-editor-string-colour);
    }
    .theme-editor-number {
      font-weight: var(--theme-editor-number-weight);
      font-style: var(--theme-editor-number-style);
      color: var(--theme-editor-number-colour);
    }
    .theme-editor-operator {
      font-weight: var(--theme-editor-operator-weight);
      font-style: var(--theme-editor-operator-style);
      color: var(--theme-editor-operator-colour);
    }
  </style>
</head>
<body>
  <nav>
    <div class="menuItem">
      <span class="menuTitle">File</span>
      <div class="menuList">
        <button>New</button>
        <button>Open</button>
        <button>Info</button>
        <button>Run</button>
      </div>
    </div>
    <div class="menuItem">
      <span class="menuTitle">Edit</span>
      <div class="menuList">
        <button>Cut</button>
        <button>Copy</button>
        <button>Paste</button>
        <button>Settings</button>
      </div>
    </div>
    <div class="menuItem">
      <span class="menuTitle">Help</span>
      <div class="menuList">
        <button>Editor</button>
        <button>Z Lang</button>
        <button>About</button>
      </div>
    </div>
    <h1>The Z Programming Language</h1>
  </nav>
  <!--<a download="hello.css" href="./zed-edit.css"></a>-->
  <main>
    <textarea id="codeInput" spellcheck="false"></textarea>
    <pre id="codePreview"></pre>
  </main>
  <script>
  function htmlEntities(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
  window.addEventListener("keydown",e=>{if(e.key == "Tab"){e.preventDefault();return false;}});
  const mainBlock = document.getElementsByTagName("main")[0];
  /** @type{HTMLTextAreaElement} */
  const codeInput = document.getElementById("codeInput");
  const codePreview = document.getElementById("codePreview");

  const TOKEN_RULES = {
  "keyword": "\\b(PROG|ENDPROG|SWITCH|WHEN|DO|ENDDO|ENDSWITCH|IF|OTHERWISE|ENDIF|FOR|FROM|TO|BY|ENDFOR|REPEAT|UNTIL|ENDWHEN|ENDREPEAT|OUT|IN)\\b",
  "number": "\\b([0-9]+)(\\.[0-9]+)?\\b",
  "math": "\\+|\\-|\\*|\\/",
  "operator": "<=|>=|<|>|==|&&|\\|\\||!|\\b(AND|NOT|OR)\\b",
  "special": ":|\\[|\\]|=",
  "string": "\"([\x20\x21\x23-\x7E])*\"",
  "variable": "\\b([A-Z]([0-9])*)\\b",
  "generic": "\\b([A-Z]+)\\b"
  };
  const zedRegexRules = [];
  for (let [k, v] of Object.entries(TOKEN_RULES)) zedRegexRules.push(`(?<${k}>${v})`);
  const zedTokenRegex = new RegExp(`(${zedRegexRules.join("|")})`,"g");

  /** @type{Storage} */
  const pageStorage = window["localStorage"];
  window.addEventListener("load",e=>{
    codeInput.value = pageStorage.getItem("userCode");
    highlightPreview();
  });

  codeInput.addEventListener("keydown", function(e){
    if (e.key === "Tab") {
      const initialPos = this.selectionStart+2;
      this.value = this.value.slice(0,this.selectionStart)+"  "+this.value.slice(this.selectionEnd);
      this.setSelectionRange(initialPos,initialPos);
      e.preventDefault();
      highlightPreview();
      return false;
    }
  });

  function highlightPreview(){
    codeInput.style.width="";codeInput.style.width = codeInput.scrollWidth + ((codeInput.scrollWidth > mainBlock.clientWidth) ? 15 : 0) + "px";
    codeInput.style.height="";codeInput.style.height = codeInput.scrollHeight + 15 + "px"
    const highlighted = lex(codeInput.value);
    codePreview.innerHTML = "<span>"+highlighted.replace(/\n/g, " </span><span>")+"</span>";
  }
  codeInput.addEventListener("input", (e)=>{
    highlightPreview();
    storeCode();
  });

  function getToken(match) {
    let type;
    let value;
    for (let [k,v] of Object.entries(match.groups)) {
      // The only available group is not undefined.
      if (v !== undefined){
        type=k;
        value=v;
        break;
      }
    }
    return {
      type: type,
      value: value,
      pos: match.index
    };
  }

  function lex(text) {
    const testResult = text.matchAll(zedTokenRegex)
    const tokenList = [];
    for (const match of testResult) {
      tokenList.push(getToken(match));
    }
    let tok;
    while (tok = tokenList.pop()) {
      text = text.slice(0,tok.pos)+`<span class="theme-editor-${tok.type}">`+htmlEntities(tok.value)+`</span>`+text.slice(tok.pos+tok.value.length);
    }
    return text;
  }
  
  function storeCode() {
    pageStorage.setItem("userCode", codeInput.value);
  }

  </script>
</body>
</html>
